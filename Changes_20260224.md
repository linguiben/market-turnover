# Changes_20260224

Date: 2026-02-24

## 用户问题 1: Global Markets 取数逻辑

### 问题
检查 `@app/web/templates/dashboard.html` 中 "Global Markets" 的取数逻辑，从哪个外部数据源拉取，写入到数据库什么表，与页面顶部的仪表盘中 "Hang Seng Index (HSI)" 显示指数价格有什么关系？

### 答案

#### 1. Global Markets 数据来源
页面从数据库 `IndexRealtimeSnapshot` 表读取数据 (routes.py 第 651-656 行):
```python
snap = db.query(IndexRealtimeSnapshot)\
    .filter(IndexRealtimeSnapshot.index_id == idx.id)\
    .filter(IndexRealtimeSnapshot.session == SessionType.FULL)\
    .order_by(IndexRealtimeSnapshot.id.desc()).first()
```

显示的指数包括 (INDEX_META 定义在 `index_quote_resolver.py`):
- **HSI** - 恒生指数 (Hang Seng Index)
- **SSE** - 上证指数 (SSE Composite Index)
- **SZSE** - 深证成指 (SZSE Component Index)
- **DJI** - 道琼斯指数 (Dow Jones)
- **IXIC** - 纳斯达克 (NASDAQ)

#### 2. 外部数据源 → 数据库表

| 外部数据源 | 写入表 | 触发 Job |
|-----------|--------|----------|
| **Tushare** (主源) | `IndexRealtimeSnapshot` | `fetch_tushare_index`, `fetch_full` |
| **Tencent** | `IndexRealtimeSnapshot` | `backfill_tencent_index` |
| **AASTOCKS** | `IndexRealtimeSnapshot` | `fetch_am`, `fetch_full` |

#### 3. 与顶部 Dashboard HSI 价格的关联

顶部仪表盘的 HSI 价格 (cards) 使用**同样的数据源**，但有 fallback 链 (routes.py 第 487-510 行):

```
1. IndexRealtimeSnapshot (session=FULL) ← 与 Global Markets 相同
         ↓ fallback
2. IndexQuoteHistory (历史报价)
         ↓ fallback  
3. HsiQuoteFact (HSI 专用事实表)
```

**关系**: 
- Global Markets 展示的所有指数价格 **直接来自** `IndexRealtimeSnapshot` 表
- 顶部 Dashboard 的 HSI 价格也 **优先使用** 同一个表的数据
- 两者数据同源，只是 Global Markets 做展示，顶部 Dashboard 额外计算成交量柱状图

---

## 用户问题 2: 增加 Global Markets 指数

### 问题
在以上10个指数的基础上，再增加韩国综合指数 HS11。实现这个功能。

### 实现内容

#### 修改 1: `app/services/index_quote_resolver.py`
- 新增 INDEX_META 条目：

```python
INDEX_META = {
    "HSI": {"name_zh": "恒生指数", "name_en": "Hang Seng Index", "market": "HK", "exchange": "HKEX", "currency": "HKD", "timezone": "Asia/Hong_Kong", "display_order": 10},
    "SSE": {"name_zh": "上证指数", "name_en": "SSE Composite Index", "market": "CN", "exchange": "SSE", "currency": "CNY", "timezone": "Asia/Shanghai", "display_order": 20},
    "SZSE": {"name_zh": "深证成指", "name_en": "SZSE Component Index", "market": "CN", "exchange": "SZSE", "currency": "CNY", "timezone": "Asia/Shanghai", "display_order": 30},
    "DJI": {"name_zh": "道琼斯指数", "name_en": "Dow Jones", "market": "US", "exchange": "NYSE", "currency": "USD", "timezone": "America/New_York", "display_order": 40},
    "IXIC": {"name_zh": "纳斯达克", "name_en": "NASDAQ", "market": "US", "exchange": "NASDAQ", "currency": "USD", "timezone": "America/New_York", "display_order": 50},
    "SPX": {"name_zh": "标普500", "name_en": "S&P 500", "market": "US", "exchange": "NYSE", "currency": "USD", "timezone": "America/New_York", "display_order": 55},
    "N225": {"name_zh": "日经225", "name_en": "Nikkei 225", "market": "JP", "exchange": "TSE", "currency": "JPY", "timezone": "Asia/Tokyo", "display_order": 60},
    "UKX": {"name_zh": "富时100", "name_en": "FTSE 100", "market": "UK", "exchange": "LSE", "currency": "GBP", "timezone": "Europe/London", "display_order": 70},
    "DAX": {"name_zh": "德国DAX", "name_en": "DAX", "market": "DE", "exchange": "Xetra", "currency": "EUR", "timezone": "Europe/Berlin", "display_order": 80},
    "ESTOXX50E": {"name_zh": "欧洲斯托克50", "name_en": "Euro Stoxx 50", "market": "EU", "exchange": "EUREX", "currency": "EUR", "timezone": "Europe/Berlin", "display_order": 90},
    "HS11": {"name_zh": "韩国综合指数", "name_en": "KOSPI", "market": "KR", "exchange": "KRX", "currency": "KRW", "timezone": "Asia/Seoul", "display_order": 35},
    # Tushare codes (for index_global API)
    "FTSE": {"name_zh": "富时100", "name_en": "FTSE 100", "market": "UK", "exchange": "LSE", "currency": "GBP", "timezone": "Europe/London", "display_order": 70},
    "GDAXI": {"name_zh": "德国DAX", "name_en": "DAX", "market": "DE", "exchange": "Xetra", "currency": "EUR", "timezone": "Europe/Berlin", "display_order": 80},
    "CSX5P": {"name_zh": "欧洲斯托克50", "name_en": "Euro Stoxx 50", "market": "EU", "exchange": "EUREX", "currency": "EUR", "timezone": "Europe/Berlin", "display_order": 90},
    "KS11": {"name_zh": "韩国综合指数", "name_en": "KOSPI", "market": "KR", "exchange": "KRX", "currency": "KRW", "timezone": "Asia/Seoul", "display_order": 35},
}
```

#### 修改 2: `app/jobs/tasks.py`
- 默认指数列表更新为 11 个：
```python
codes = ["HSI", "SSE", "SZSE", "HS11", "DJI", "IXIC", "SPX", "N225", "UKX", "DAX", "ESTOXX50E"]
```

- 新增 Tencent 行情接口映射（第 1032-1098 行）：

| Code | Tencent Symbol | Currency | Timezone |
|------|---------------|----------|----------|
| SPX | usSPX | USD | America/New_York |
| N225 | jpN225 | JPY | Asia/Tokyo |
| UKX | ukUKX | GBP | Europe/London |
| DAX | euDAX | EUR | Europe/Berlin |
| ESTOXX50E | euESTOXX50E | EUR | Europe/Berlin |
| HS11 | krHS11 | KRW | Asia/Seoul |

#### 页面显示顺序 (按 display_order)
1. HSI (10) - 恒生指数
2. SSE (20) - 上证指数
3. SZSE (30) - 深证成指
4. **HS11 (35)** - 韩国综合指数 ← 新增
5. DJI (40) - 道琼斯指数
6. IXIC (50) - 纳斯达克
7. SPX (55) - 标普500 ← 新增
8. N225 (60) - 日经225 ← 新增
9. UKX (70) - 富时100 ← 新增
10. DAX (80) - 德国DAX ← 新增
11. ESTOXX50E (90) - 欧洲斯托克50 ← 新增

---

## 用户问题 3: Tushare Pro 指数拉取

### 问题
检查目前的 job 中有没有从 tushare.pro 拉取交易所指数实时日线（接口：rt_idx_k）和 国际指数（接口：index_global），若有拉取是在哪个 job？拉取的指数有哪些，频率如何？

### 答案

#### 1. Tushare `rt_idx_k` (实时指数行情接口)
**当前代码中未使用** - 没有任何引用。

#### 2. Tushare `index_global` 接口
**有使用** - 位置: `app/sources/tushare_index.py` 第 107-110 行

```python
# CN indices (e.g. 000001.SH) use index_daily; global indices like HSI use index_global.
if "." in ts_code:
    api_name = "index_daily"
else:
    api_name = "index_global"  # ← 无点号的指数使用此接口
```

#### 3. 拉取 Tushare 指数日线的 Job

| Job | 调用函数 | 频率 (Cron) | 说明 |
|-----|---------|-------------|------|
| **`fetch_tushare_index`** | `_sync_tushare_index_quotes()` | 每日 20:00 | 独立任务，同步最新 Tushare 日线 |
| **`fetch_am`** | `_sync_tushare_index_quotes()` | 工作日 11:35 | 午盘抓取 + 同步 Tushare |
| **`fetch_full`** | `_sync_tushare_index_quotes()` | 工作日 16:10 | 全日抓取 + 同步 Tushare |
| **`backfill_tushare_index`** | `_backfill_tushare_index_quotes()` | 手动 | 回填历史日线 (默认365天) |

#### 4. 修改: 添加 Global Markets 指数到 Tushare Job

**修改 `app/config.py`**:
```python
# 原配置:
TUSHARE_INDEX_CODES=HSI=HSI.HI,SSE=000001.SH,SZSE=399001.SZ

# 新配置:
TUSHARE_INDEX_CODES=HSI=HSI.HI,SSE=000001.SH,SZSE=399001.SZ,DJI=DJI,IXIC=IXIC,SPX=SPX,FTSE=FTSE,GDAXI=GDAXI,N225=N225,KS11=KS11,CSX5P=CSX5P
```

| Code | Tushare ts_code | 使用接口 | 说明 |
|------|----------------|----------|------|
| HSI | HSI.HI | index_daily | 恒生指数 |
| SSE | 000001.SH | index_daily | 上证指数 |
| SZSE | 399001.SZ | index_daily | 深证成指 |
| DJI | DJI | index_global | 道琼斯工业指数 ← 新增 |
| IXIC | IXIC | index_global | 纳斯达克指数 ← 新增 |
| SPX | SPX | index_global | 标普500指数 ← 新增 |
| FTSE | FTSE | index_global | 富时100指数 ← 新增 |
| GDAXI | GDAXI | index_global | 德国DAX指数 ← 新增 |
| N225 | N225 | index_global | 日经225指数 ← 新增 |
| KS11 | KS11 | index_global | 韩国综合指数 ← 新增 |
| CSX5P | CSX5P | index_global | 欧洲斯托克50 ← 新增 |

#### 5. Tushare index_global 支持的指数代码 (参考)

| ts_code | 指数名称 |
|---------|----------|
| HSI | 恒生指数 |
| DJI | 道琼斯工业指数 |
| SPX | 标普500指数 |
| IXIC | 纳斯达克指数 |
| FTSE | 富时100指数 |
| FCHI | 法国CAC40指数 |
| GDAXI | 德国DAX指数 |
| N225 | 日经225指数 |
| KS11 | 韩国综合指数 |
| AS51 | 澳大利亚标普200指数 |
| TWII | 台湾加权指数 |
| CSX5P | STOXX欧洲50指数 |

---

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `app/services/index_quote_resolver.py` | 修改 | 新增 11 个指数的 INDEX_META 定义 |
| `app/jobs/tasks.py` | 修改 | 新增 Tencent 行情接口映射 (SPX, N225, UKX, DAX, ESTOXX50E, HS11) |
| `app/config.py` | 修改 | 更新 TUSHARE_INDEX_CODES 配置，新增 8 个指数 |
| `env.example` | 修改 | 更新 TUSHARE_INDEX_CODES 配置示例 |
| `app/web/routes.py` | 修改 | 更新 Jobs 页面描述，包含新的 11 个指数 |
| `Changes_20260224.md` | 新增 | 变更记录文档 |

---

## 触发数据拉取

```bash
# 重新运行 fetch_intraday_snapshot 拉取所有11个指数数据 (Tencent)
curl -X POST -F 'job_name=fetch_intraday_snapshot' http://localhost:8000/market-turnover/api/jobs/run

# 重新运行 fetch_tushare_index 拉取 Tushare 日线数据
curl -X POST -F 'job_name=fetch_tushare_index' http://localhost:8000/market-turnover/api/jobs/run

# 回填 Tushare 历史日线
curl -X POST -F 'job_name=backfill_tushare_index' http://localhost:8000/market-turnover/api/jobs/run
```
