{% extends "base.html" %}
{% block content %}
<h2>Jobs</h2>
{% set base = (request.scope.get('root_path') or '') %}

<h3>Available jobs</h3>
<table>
  <thead><tr><th>Job</th><th>Description</th><th>Target tables</th><th>Last Status</th><th>Action</th></tr></thead>
  <tbody>
  <script>
    function copySqlExample(btn) {
      const sql = btn.getAttribute('data-sql') || '';
      if (!sql) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(sql);
        btn.textContent = 'copied';
        setTimeout(() => (btn.textContent = 'copy'), 800);
        return;
      }
      const ta = document.createElement('textarea');
      ta.value = sql;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      btn.textContent = 'copied';
      setTimeout(() => (btn.textContent = 'copy'), 800);
    }
  </script>
  {% for item in available_jobs %}
    {% set latest = latest_run_by_name.get(item.name) %}
    <tr>
      <td><code>{{ item.name }}</code><br><span class="muted">{{ item.label }}</span></td>
      <td>{{ item.description }}</td>
      <td>
        {% if item.targets %}
          {% set tables = (item.targets | join(', ')) %}
          {% set sql = "-- example: inspect recent rows\n" ~ ("SELECT * FROM " ~ item.targets[0] ~ " ORDER BY id DESC LIMIT 20;") %}
          {% if item.targets|length > 1 %}
            {% set sql = sql ~ "\n\n-- example: per-table counts\n" %}
            {% for t in item.targets %}
              {% set sql = sql ~ ("SELECT '" ~ t ~ "' AS table, COUNT(*) AS rows FROM " ~ t ~ ";\n") %}
            {% endfor %}
          {% endif %}

          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
            <code>{{ tables }}</code>
            <button
              type="button"
              class="muted"
              style="border:1px solid #ddd; background:#fff; padding:2px 6px; cursor:pointer;"
              title="Copy SQL example"
              data-sql="{{ sql | replace('\n','&#10;') }}"
              onclick="copySqlExample(this)"
            >copy</button>
          </div>
        {% else %}
          <span class="muted">-</span>
        {% endif %}
      </td>
      <td>
        {% if latest %}
          <strong>{{ latest.status }}</strong><br>
          <span class="muted">{{ latest.started_at }}</span>
        {% else %}
          <span class="muted">never</span>
        {% endif %}
      </td>
      <td>
        <form method="post" action="{{ base }}/api/jobs/run">
          <input type="hidden" name="job_name" value="{{ item.name }}" />

          {% if item.params %}
            <details>
              <summary class="muted">Params</summary>
              <div style="margin: 8px 0; display: grid; gap: 6px;">
                {% for p in item.params %}
                  <label>
                    <span class="muted">{{ p.label }}</span><br />
                    <input
                      style="width: 100%;"
                      name="param_{{ p.name }}"
                      type="{{ 'number' if p.type == 'number' else 'text' }}"
                      placeholder="{{ p.placeholder or '' }}"
                    />
                  </label>
                {% endfor %}
                <label>
                  <span class="muted">params_json (advanced)</span><br />
                  <textarea name="params_json" style="width: 100%;" rows="4" placeholder='{"key":"value"}'></textarea>
                </label>
              </div>
            </details>
          {% else %}
            <input type="hidden" name="params_json" value="" />
          {% endif %}

          <button type="submit">Run</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<h3>Run history</h3>
<table>
  <thead><tr><th>Job</th><th>Started</th><th>Finished</th><th>Status</th><th>Error</th></tr></thead>
  <tbody>
  {% for row in jobs %}
    <tr>
      <td>{{ row.job_name }}</td>
      <td>{{ row.started_at }}</td>
      <td>{{ row.finished_at or '' }}</td>
      <td>{{ row.status }}</td>
      <td><pre style="white-space: pre-wrap;">{{ row.error or '' }}</pre></td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
